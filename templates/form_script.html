{% load static %}
<script>
(function(){
  const root = document.getElementById('callback-form');
  if (!root) return;

  const form = root.querySelector('form');

  // ставим action/method программно (разметку не редактируем)
  form.setAttribute('action', "{% url 'contact_request_create' %}");
  form.setAttribute('method', 'post');

  // получаем CSRF из cookie (стандартно для Django)
  function getCookie(name){
    const m = document.cookie.match(new RegExp('(^|; )' + name + '=([^;]+)'));
    return m ? decodeURIComponent(m[2]) : null;
  }
  const csrftoken = getCookie('csrftoken');

  // простая подсветка ошибок
  function highlightErrors(errors){
    // снимаем прошлые состояния
    form.querySelectorAll('.has-error').forEach(el => el.classList.remove('has-error'));

    if(!errors) return;
    for (const [name] of Object.entries(errors)){
      const field = form.querySelector(`[name="${name}"]`);
      if (field){
        field.classList.add('has-error');
        field.addEventListener('input', ()=> field.classList.remove('has-error'), {once:true});
      }
    }
  }

  // лёгкий тост
  function toast(msg){
    let node = document.getElementById('cb-toast');
    if(!node){
      node = document.createElement('div');
      node.id = 'cb-toast';
      node.style.position = 'fixed';
      node.style.left = '50%';
      node.style.bottom = '24px';
      node.style.transform = 'translateX(-50%)';
      node.style.background = '#111';
      node.style.color = '#fff';
      node.style.padding = '10px 14px';
      node.style.borderRadius = '10px';
      node.style.zIndex = '99999';
      node.style.opacity = '0';
      node.style.transition = 'opacity .2s';
      document.body.appendChild(node);
    }
    node.textContent = msg;
    node.style.opacity = '1';
    setTimeout(()=> node.style.opacity = '0', 2500);
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const btn = form.querySelector('button[type="submit"]') || form.querySelector('.callback-form-btn');
    if (btn) btn.disabled = true;

    // читаем ваши поля
    const fd = new FormData(form);

    // переводим в "канонические" поля бэкенда
    const payload = new FormData();
    payload.append('first_name',  fd.get('name')    || '');
    payload.append('last_name',   fd.get('surname') || '');
    payload.append('email',       fd.get('email')   || '');
    payload.append('phone',       fd.get('phone')   || '');
    payload.append('description', fd.get('about')   || '');

    try{
      const res = await fetch(form.action, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken || '',
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: payload
      });

      const data = await res.json().catch(()=> ({}));

      if(!res.ok || !data.ok){
        highlightErrors(data.errors);
        throw new Error('validation');
      }

      form.reset();
      toast('Заявка отправлена. Спасибо!');
      // если форма в модалке — можешь закрыть здесь, например:
      // document.querySelector('[data-close]')?.click();

    } catch(err){
      toast('Не удалось отправить. Проверьте поля и повторите.');
    } finally {
      if (btn) btn.disabled = false;
    }
  });
})();
</script>
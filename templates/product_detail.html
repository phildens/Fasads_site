{% extends "base.html" %}
{% load static %}

{% block title %}Товар{% endblock %}

{% block extra_css %}
    <style>
        /* --- Общий контейнер --- */
        .product-page {
            max-width: 1180px;
            margin: 0 auto;
            padding: 24px 16px 64px;
            font-family: Montserrat, Arial, sans-serif;
            box-sizing: border-box
        }

        /* Крошки и заголовок */
        .crumbs {
            font-size: 13px;
            color: #7b6a68;
            margin-bottom: 6px
        }

        .crumbs {
            margin-bottom: 18px;
            margin-top: 33px;

            font-family: Muller-regular;
            font-weight: 400;
            font-size: 16px;
            color: #000000;
        }

        .crumbs a {
            color: inherit;
            text-decoration: none
        }

        .product-title {
            font-family: Muller-medium;

            font-size: 50px;
            font-weight: 500;
            line-height: 100%;
            letter-spacing: 0;
            margin: 8px 0 18px;
            color: #422223
        }

        /* --- Сетка: десктоп (как было) --- */
        .product-grid {
            display: grid;
            grid-template-columns:1fr 360px;
            gap: 28px;
            align-items: start
        }

        @media (max-width: 992px) {
            .product-grid {
                display: block
            }
        }

        /* Галерея */
        .gallery {
            width: 100%
        }

        .main-photo {
            border-radius: 10px;
        {#background: #f4f2f1;#} overflow: hidden;
            position: relative;
        {#border: 6px solid rgba(63, 138, 255, 0.12)#}
        }

        .main-photo img.main-img {
            width: 100%;
            height: 520px;
            object-fit: cover;
            display: block
        }

        /* Миниатюры — справа сверху на фото */
        .thumbs {
            position: absolute;
            right: 20px;
            top: 20px;
            display: flex;
            flex-direction: column;
            gap: 14px;
            z-index: 6
        }

        .thumb {
            width: 98px;
            height: 98px;
            border-radius: 12px;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 9px 18px rgba(0, 0, 0, 0.12);
            cursor: pointer;
            overflow: hidden;
            border: 1px solid #efeaea
        }

        .thumb img {
            width: 70px;
            height: 70px;
            object-fit: contain;
            display: block
        }

        .thumb.active {
            outline: 3px solid rgba(63, 138, 255, 0.18);
            transform: translateY(-2px)
        }

        @media (max-width: 720px) {
            .thumbs {
                position: static;
                flex-direction: row;
                padding: 8px;
                overflow: auto;
                background: transparent;
                margin-top: 12px;
                gap: 10px
            }

            .main-photo img.main-img {
                height: 360px
            }
        }

        /* Правая колонка */
        .side-card {
            background: radial-gradient(50% 50% at 50% 50%, #422223 0%, #523A36 100%);

            color: #fff;
            border-radius: 10px;
            padding: 18px
        }

        .side-card .btn {
            display: block;
            width: 100%;
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 10px;
            border: 0
        }
        .pbb {
            border-radius: 10px;
            border: 1px solid white !important;
            height: 49px;
            font-family: Muller-light;
            font-weight: 400;
            font-size: 18px;
            line-height: 100%;
            letter-spacing: 0;

        }

        .btn-white {
            background: #fff;
            color: #3c2423
        }

        .btn-ghost {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff
        }

        .call-card {
            background: #fff;
            border-radius: 10px;
            padding: 27px;
            margin-top: 27px
        }
        .call-btn {
            background:#fff;
            border:1px solid #422223;
            height: 49px;
            border-radius:10px;
            width:100%;
            font-family: Muller-regular;
            font-weight: 400;
            font-size: 18px;
            line-height: 100%;
            letter-spacing: 0;

        }
        .wbb {
            height: 49px;
            border-radius: 10px;
            color: #422223;
            font-family: Muller-regular;
            font-weight: 400;
            font-size: 18px;
            line-height: 100%;
            letter-spacing: 0;

        }



        .green-card {
            background: #327F00;
            
            padding-left: 27px;
            padding-top: 31px;
            padding-bottom: 33px;
            padding-right: 33px;
            color: #fff;
            border-radius: 10px;
            
            margin-top: 30px;
            font-family: Muller-light;
            font-weight: 200;
            font-size: 18px;
            line-height: 100%;
            letter-spacing: 0;

        }
        
        .bopen-gal {
            
        }

        .price-individ {
            font-family: Muller-regular;
            font-weight: 400;
            font-size: 20px;
            line-height: 100%;
            margin-bottom: 70px;
            letter-spacing: 0%;

        }

        .green-card .btn {
            background: #fff;
            border-radius: 10px;
            width: 100%;
            border: none;
            height: 50px;
            font-family: Muller-light;
            
            font-weight: 300;
            font-size: 18px;
            line-height: 100%;
            letter-spacing: 0;
            margin-top: 122px;

        }

        @media (max-width: 992px) {
            .side-card, .call-card, .green-card {
                margin-top: 12px
            }
        }

        /* =========================
           Характеристики (унификация 98×98)
           ========================= */

        /* ДЕСКТОП: строгая сетка из плиток 98×98 */
        .specs {
            display: grid;
            grid-template-columns:repeat(auto-fill, 98px); /* все плитки ровно 98px */
            gap: 30px;
            margin: 20px 0 12px;
            align-items: start;
            justify-content: flex-start; /* выравниваем к левому краю */
        }

        /* Карточка характеристики — ровно 98×98 везде */
        .spec-wrapper {
            position: relative;
            width: 98px;
            height: 98px;
        }

        /* Внутренний блок — тоже 98×98 */
        .spec {
            width: 98px;
            height: 98px;
            background: #fff;
            border-radius: 12px;
            border: 1px solid #efeaea;
            box-sizing: border-box;
            padding: 10px 8px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: flex-start;
            gap: 9px;
            text-align: left;
        }

        /* Круглый индикатор */
        .spec-icon {
            position: absolute;
            left: -18px; /* На десктопе слегка «нависает» */
            top: -10px;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: none;
            border: 1px solid #422223;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #422223;
            font-family: Muller-regular;
            font-weight: 700;
            font-size: 13px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06)
        }

        /* Тексты внутри плитки — компактно и без переполнения */
        .spec__label {
            font-family: Muller-regular;
            font-weight: 400;
            font-size: 15px;
            line-height: 100%;
            letter-spacing: 0;
            color: #422223;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden
        }

        .spec__value {
            font-family: Muller-regular;
            font-weight: 400;
            font-size: 14px;
            line-height: 100%;
            letter-spacing: 0;
            color: #422223;

            font-family: Muller-regular;
            font-weight: 400;
            font-size: 14px;
            line-height: 100%;
            letter-spacing: 0;
            color: #422223;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden
        }

        /* Описание */
        .desc {
            margin-top: 8px;
            color: #3a2a29;
            line-height: 1.65
             white-space: pre-wrap; /* \n становится переносом строки */
  tab-size: 4;           /* ширина табуляции */
  word-break: break-word;
        }
        /* учитывает реальные переводы строк и табы */


        .desc p {
            margin-bottom: 12px;
            font-family: Muller-regular;
            font-weight: 400;
            font-size: 20px;
            line-height: 100%;
            letter-spacing: 0;
            color: #422223;

        }

        /* Скелетоны */
        .skeleton {
            background: linear-gradient(90deg, #eee, #f6f6f6, #eee);
            background-size: 200% 100%;
            animation: sk 1.2s infinite;
            border-radius: 8px
        }

        @keyframes sk {
            0% {
                background-position: 200% 0
            }
            100% {
                background-position: -200% 0
            }
        }

        /* --- МОБИЛЬНЫЙ СЛАЙДЕР характеристик без кнопок --- */
        @media (max-width: 720px) {
            .specs {
                display: flex; /* слайдер */
                gap: 12px;
                margin: 16px 0 8px;
                padding: 6px 12px 6px 18px; /* ВАЖНО: небольшой левый отступ, чтобы круг не обрезался */
                overflow-x: auto;
                overflow-y: visible;
                scroll-snap-type: x mandatory;
                -webkit-overflow-scrolling: touch;
            }

            .spec-wrapper {
                flex: 0 0 98px; /* фиксированная ширина плитки в ленте */
                width: 98px;
                height: 98px;
                scroll-snap-align: start;
            }

            .spec {
                width: 98px;
                height: 98px;
                padding: 10px 8px;
            }

            .spec-icon {
                left: -14px;
                top: 6px; /* компактнее на мобилке */
                width: 26px;
                height: 26px;
                font-size: 12px
            }
        }

        /* (Необязательная подстраховка — если сетка была переопределена где-то ещё) */
        @media (min-width: 721px) {
            .spec-wrapper, .spec {
                width: 110px;
                height: 98px
            }
        }
    </style>
{% endblock %}

{% block content %}
    <div class="product-page" data-product-id="{{ product_id }}">
        <div style="height: 1px; background-color: black;"></div>
        <!-- Крошки -->
        <div class="crumbs">
            <a href="/">Главная</a> <span>›</span>
            <a href="/catalog/">Продукция</a> <span>›</span>
            <span id="crumb-category" class="skeleton"
                  style="display:inline-block;width:140px;height:12px;border-radius:6px;"></span>
        </div>

        <!-- Заголовок -->
        <h1 id="product-title" class="product-title skeleton" style="width:60%;height:44px;border-radius:10px"></h1>

        <div class="product-grid">
            <!-- Левая колонка -->
            <div id="left-col">
                <div class="gallery" id="gallery">
                    <div class="main-photo" id="main-photo">
                        <div id="thumbs" class="thumbs" aria-hidden="false"></div>
                        <img class="main-img skeleton" alt="" src="">
                    </div>

                    <!-- Характеристики и описание (десктоп: тут; мобилка: JS перенесёт под зелёный блок) -->
                    <div class="specs" id="specs"></div>
                    <div class="desc" id="description"></div>
                </div>
            </div>

            <!-- Правая колонка -->
            <aside id="right-col">
                <div class="side-card">
                    <div style="opacity:.85;font-size:14px;margin-bottom:6px">Цена:</div>
                    <div class="price-individ" style="font-size:16px;" id="price">рассчитывается <br>индивидуально</div>
                    <button class="to-callback btn btn-white wbb" id="">Получить консультацию</button>
                    <button class="to-callback btn btn-white wbb" id="">Узнать цену</button>
                    <button  id="favBtn"
                          class="fav-btn btn btn-ghost pbb"
                          data-fav-btn
                          data-label-add="В избранное"
                          data-label-remove="В избранном"
                          data-product-id="{{ product_id }}"
                          data-product-name=""
                          data-product-image=""
                          data-product-url="/p/{{ product_id }}/"
                          aria-pressed="false"
                    >Добавить в избранное</button>
                </div>

                <div class="call-card">
                    <div style="font-family: Muller-regular;
                                font-weight: 400;
                                font-size: 18px;
                                line-height: 100%;
                                letter-spacing: 0;
                                margin-bottom: 31px" >
                        Заказать обратный звонок
                    </div>
                    <button class="to-callback btn call-btn" style="cursor: pointer" onclick="" id="moveToTargetBtn">
                        Заказать звонок
                    </button>
                </div>

                <div class="green-card" id="green-card">
                    <div style="margin-bottom:8px">Посмотрите, как данный материал смотрится на реализованных объектах
                    </div>
                    <button class="btn bopen-gal" onclick="window.location.href='{% url 'galery' %}'" style="cursor: pointer">Открыть галерею</button>
                </div>
            </aside>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script>
(function () {
  const page = document.querySelector('.product-page');
  const productId = page?.dataset.productId;
  if (!productId) return;

  const $ = (sel, root = document) => root.querySelector(sel);
  const el = (tag, cls, html) => {
    const n = document.createElement(tag);
    if (cls) n.className = cls;
    if (html !== undefined) n.innerHTML = html;
    return n;
  };

  async function loadProduct() {
    const url = `/api/products/${productId}/`;
    const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
    if (!res.ok) throw new Error('Failed to load product');
    return await res.json();
  }

  function normalizeImages(images, card_image) {
    if (!images || !images.length) {
      return card_image ? [{ url: card_image, alt: '' }] : [];
    }
    return images.map(i =>
      typeof i === 'string'
        ? ({ url: i, alt: '' })
        : ({ url: i.url || i.path || '', alt: i.alt || i.name || '' })
    );
  }

  function renderTitle(prod) {
    const title = $('#product-title');
    title.classList.remove('skeleton');
    title.style.height = '';
    title.style.width = '';
    title.textContent = prod.name || 'Товар';

    const crumbCat = $('#crumb-category');
    crumbCat.classList.remove('skeleton');
    crumbCat.style.width = '';
    crumbCat.style.height = '';
    crumbCat.textContent = (prod.category?.name) || (prod.category?.field_name) || 'Категория';
  }

  function renderGallery(prod) {
    const mainPhoto = $('#main-photo');
    const mainImg = $('.main-img', mainPhoto);
    const thumbs = $('#thumbs');
    thumbs.innerHTML = '';
    mainImg.classList.remove('skeleton');

    const pics = normalizeImages(prod.images, prod.card_image);
    if (!pics.length) {
      mainImg.src = '{% static "img/no-image.png" %}';
      return;
    }
    mainImg.src = pics[0].url;

    pics.forEach((p, i) => {
      const t = el('div', 'thumb' + (i === 0 ? ' active' : ''));
      const im = el('img', '', '');
      im.src = p.url;
      im.alt = p.alt || prod.name || '';
      t.appendChild(im);
      t.addEventListener('click', () => {
        thumbs.querySelectorAll('.thumb').forEach(n => n.classList.remove('active'));
        t.classList.add('active');
        mainImg.src = im.src;
      });
      thumbs.appendChild(t);
    });
  }

  function renderSpecs(prod) {
    const specs = $('#specs');
    specs.innerHTML = '';

    const fieldMap = [
      { key: 'formats',          label: () => 'Формат',                  value: p => (p.formats || []).map(x => x?.name).filter(Boolean).join('; ') },
      { key: 'strength_grade',   label: p => p.strength_grade?.field_name || 'Марка прочности', value: p => p.strength_grade?.name },
      { key: 'water_resistance', label: p => 'Водопогло\nщение',          value: p => p.water_resistance?.name },
      { key: 'color',            label: p => p.color?.field_name || 'Оттенок', value: p => p.color?.name },
      { key: 'frosen_defend',    label: p => 'Морозосто\nйкость',         value: p => p.frosen_defend?.name },
      { key: 'manufacturer',     label: p => 'Бренд',                     value: p => p.manufacturer?.name },
    ];

    const attrs = [];
    for (const f of fieldMap) {
      const val = f.value(prod);
      const text = (typeof val === 'string' ? val.trim() : val);
      if (text) attrs.push({ label: (typeof f.label === 'function' ? f.label(prod) : f.label), value: text });
    }

    attrs.forEach(attr => {
      const wrap = el('div', 'spec-wrapper');
      const icon = el('div', 'spec-icon', 'i');
      const box = el('div', 'spec');
      const lab = el('div', 'spec__label', attr.label || '');
      const val = el('div', 'spec__value', attr.value);
      box.appendChild(lab);
      box.appendChild(val);
      wrap.appendChild(icon);
      wrap.appendChild(box);
      specs.appendChild(wrap);
    });

    // drag-scroll для мобилок (не мешает десктопу)
    let isDown = false, startX = 0, startScroll = 0;
    const isMobile = () => window.matchMedia('(max-width: 720px)').matches;
    specs.addEventListener('pointerdown', (e) => {
      if (!isMobile()) return;
      isDown = true;
      startX = e.clientX;
      startScroll = specs.scrollLeft;
      specs.setPointerCapture(e.pointerId);
    });
    specs.addEventListener('pointermove', (e) => {
      if (!isDown || !isMobile()) return;
      specs.scrollLeft = startScroll - (e.clientX - startX);
    });
    specs.addEventListener('pointerup', () => isDown = false);
    specs.addEventListener('pointercancel', () => isDown = false);
  }

  function renderPrice(prod) {
    $('#price').innerHTML = prod.price_text || 'рассчитывается<br>индивидуально';
  }

function normalizeUserText(s){
  if (!s) return '';
  // Превращаем последовательности "\r\n", "\n", "\r" в настоящий перевод строки
  s = s.replace(/\\r\\n/g, '\n')
       .replace(/\\n/g, '\n')
       .replace(/\\r/g, '\n')
       .replace(/\\t/g, '\t');

  // Чуть чистим лишние пустые строки (по желанию)
  s = s.replace(/\n{3,}/g, '\n\n');

  return s.trim();
}

function renderDescription(prod) {
  const node = document.getElementById('description');
  node.innerHTML = '';

  if (prod.description_html) {
    // если с сервера уже пришла готовая HTML-верстка описания — просто вставляем
    node.innerHTML = prod.description_html;
    return;
  }

  // обычный текст — нормализуем и даём браузеру отрисовать переносы по CSS
  const text = normalizeUserText(prod.description || '');
  node.textContent = text;
}


  // Перестановка блоков на мобилках
  const specsEl = $('#specs');
  const descEl  = $('#description');
  const gallery = $('#gallery');
  const green   = $('#green-card');
  function placeForMobile() {
    if (window.matchMedia('(max-width: 992px)').matches) {
      if (green && specsEl && specsEl.parentElement !== green.parentElement) {
        green.after(specsEl);
        specsEl.after(descEl);
      } else if (green && specsEl && specsEl.previousElementSibling !== green) {
        green.after(specsEl);
        specsEl.after(descEl);
      }
    } else {
      if (gallery && specsEl && specsEl.parentElement !== gallery) {
        gallery.appendChild(specsEl);
        gallery.appendChild(descEl);
      }
    }
  }

  // --- Новое: безопасная инициализация избранного ---
  function setupFavorites(prod) {
    const favBtn = document.getElementById('favBtn');
    if (!favBtn || !prod) return;

    // Заполняем атрибуты для localStorage
    favBtn.setAttribute('data-product-id', String(prod.id));
    favBtn.setAttribute('data-product-name', prod.name || '');
    favBtn.setAttribute('data-product-image', prod.card_image || '');
    favBtn.setAttribute('data-product-url', `/p/${prod.id}/`);

    // Разрешаем клик на всякий случай (если кто-то его дизейблил)
    favBtn.removeAttribute('disabled');

    // Обновляем состояние кнопки и счётчик, если менеджер подключён
    if (window.SFFavorites) {
      document.dispatchEvent(new CustomEvent('sf:favs-changed'));
    }
  }

  // Инициализация
  async function init() {
    try {
      const product = await loadProduct();
      renderTitle(product);
      renderGallery(product);
      renderSpecs(product);
      renderPrice(product);
      renderDescription(product);

      // <— Важно: вызываем ПОСЛЕ того, как получили product
      setupFavorites(product);

      placeForMobile();
      window.addEventListener('resize', placeForMobile);
    } catch (e) {
      console.error(e);
      page.insertAdjacentHTML('beforeend',
        `<div style="margin-top:18px;color:#9b2b2b">Не удалось загрузить данные товара.</div>`);
    }
  }

  init();
})();

</script>
    <script>

    </script>
    <script>
document.addEventListener('DOMContentLoaded', function () {
  const target = document.getElementById('callback-form');
  if (!target) return;

  document.querySelectorAll('.to-callback').forEach(btn => {
    btn.addEventListener('click', function (e) {
      e.preventDefault();
      // Если нужен точный отступ (при фикс. шапке), используйте ручной скролл:
      // smoothScrollTo(target, 80); // 80 — высота шапки
      target.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });
  });

  // Опционально: ручной скролл с учётом фиксированного хедера
  function smoothScrollTo(el, offset = 0) {
    const top = el.getBoundingClientRect().top + window.pageYOffset - offset;
    window.scrollTo({ top, behavior: 'smooth' });
  }
});
</script>

{% endblock %}
